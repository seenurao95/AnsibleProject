---

- hosts: all
  become: true
  tasks: 

         - name: install updates
           yum:
                update_only: yes
                update_cache: yes
           when: ansible_distribution == "CentOS"

         - name: install apache and php package
           package:
                name: 
                    - "{{ httpd }}"
                    - "{{ tmux }}"
                    - "{{ php }}"         
                state: latest
                update_cache: yes

- hosts: all
  become: true
  tasks:
          - name: create simone user
            tags: always
            user:
                    name: simone
                    groups: root
          
           - name: add ssh key for simone
             tags: always
             authorized_key:
                     user: simone
                     key: ""
                    
    
- hosts: workstations
  become: true
  tasks:
          - name: install unzip
            package: 
                name: unzip

          - name: install terraform
            unarchive:
                src: https://releases.hashicorp.com/terraform/1.2.9/terraform_1.2.9_linux_arm64.zip
                dest: /usr/local/bin
                remote_src: yes
                mode: 0755
                owner: root
                group: root


- hosts: web_servers
  become: true
  tasks:

          - name: install apache and php for CentOS servers
            tags: centos, web servers, httpd, apache
            package:
                   name:
                       - httpd
                       - php
                   state: latest
            when: ansible_distribution == "CentOS"

          - name: copy default html file for site
            tags: html, webserver,httpd, apache2, apache
            copy: 
                   src: default_site.html
                   dest: /var/www/html/index.html
                   owner: root
                   group: root
                   mode: 0644

          - name: change e-mail address for admin
            tags: apache, centos, httpd
            lineinfile:
                    path: /etc/httpd/conf/httpd.conf
                    regexp: '^ServerAdmin'
                    line: ServerAdmin somebody@somewhere.net
            register: httpd

          - name: restart httpd (CentOS)
            tags: apache,centos,httpd
            service:
                    name: httpd
                    state: restarted
            when: httpd.changed

          - name: start httpd (CentOS)
            tags: httpd, apache2, apache
            ansible.builtin.systemd:
                    name: httpd
                    enabled: yes
                    state: started
            when: ansible_distribution == "CentOS"


- hosts: db_servers
  become: true
  tasks:
          - name: install mariadb package (CentOS)
            tags: database, mariadb, centos
            yum:
                    name:
                            - mariadb
                            - mariadb-server

                    state: latest
            when: ansible_distribution == "CentOS"


